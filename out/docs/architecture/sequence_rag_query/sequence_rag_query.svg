<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1353px" preserveAspectRatio="none" style="width:1637px;height:1353px;" version="1.1" viewBox="0 0 1637 1353" width="1637px" zoomAndPan="magnify"><defs><filter height="300%" id="f1lbbt3w3hemu4" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="442" x="594" y="29.4023">RAG Query Flow (Retrieval-Augmented Generation)</text><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="1095.627" style="stroke:#A80036;stroke-width:1.0;" width="10" x="191.5" y="154.998"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="1037.0059" style="stroke:#A80036;stroke-width:1.0;" width="10" x="425.5" y="184.3086"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="809.1426" style="stroke:#A80036;stroke-width:1.0;" width="10" x="654.5" y="298.2402"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="257.1738" style="stroke:#A80036;stroke-width:1.0;" width="10" x="905.5" y="370.8613"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="113.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1133.5" y="400.1719"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="215.1738" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1295.5" y="827.5879"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="185.8633" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1557.5" y="856.8984"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="163.8633" style="stroke:#000000;stroke-width:2.0;" width="1610" x="10" y="871.8984"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="38" x2="38" y1="123.6875" y2="1268.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="196" x2="196" y1="123.6875" y2="1268.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="430.5" x2="430.5" y1="123.6875" y2="1268.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="659" x2="659" y1="123.6875" y2="1268.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="910.5" x2="910.5" y1="123.6875" y2="1268.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1138" x2="1138" y1="123.6875" y2="1268.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1300" x2="1300" y1="123.6875" y2="1268.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1562" x2="1562" y1="123.6875" y2="1268.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="20" y="120.7344">User</text><ellipse cx="38.5" cy="50.1992" fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M38.5,58.1992 L38.5,85.1992 M25.5,66.1992 L51.5,66.1992 M38.5,85.1992 L25.5,100.1992 M38.5,85.1992 L51.5,100.1992 " fill="none" filter="url(#f1lbbt3w3hemu4)" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="20" y="1281.1602">User</text><ellipse cx="38.5" cy="1294.1133" fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M38.5,1302.1133 L38.5,1329.1133 M25.5,1310.1133 L51.5,1310.1133 M38.5,1329.1133 L25.5,1344.1133 M38.5,1329.1133 L51.5,1344.1133 " fill="none" filter="url(#f1lbbt3w3hemu4)" style="stroke:#A80036;stroke-width:2.0;"/><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="93" x="148" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="155" y="108.7344">Streamlit UI</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="93" x="148" y="1267.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="155" y="1288.1602">Streamlit UI</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="98" x="379.5" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="386.5" y="108.7344">Chat Service</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="98" x="379.5" y="1267.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="386.5" y="1288.1602">Chat Service</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="95" x="610" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="81" x="617" y="108.7344">RAG Service</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="95" x="610" y="1267.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="81" x="617" y="1288.1602">RAG Service</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="212" x="802.5" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="198" x="809.5" y="108.7344">ChromaDocumentRepository</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="212" x="802.5" y="1267.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="198" x="809.5" y="1288.1602">ChromaDocumentRepository</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="87" x="1093" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="1100" y="108.7344">ChromaDB</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="87" x="1093" y="1267.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="1100" y="1288.1602">ChromaDB</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="117" x="1240" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="1247" y="108.7344">OpenAI Service</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="117" x="1240" y="1267.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="1247" y="1288.1602">OpenAI Service</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="91" x="1515" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="77" x="1522" y="108.7344">OpenAI API</text><rect fill="#FEFECE" filter="url(#f1lbbt3w3hemu4)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="91" x="1515" y="1267.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="77" x="1522" y="1288.1602">OpenAI API</text><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="1095.627" style="stroke:#A80036;stroke-width:1.0;" width="10" x="191.5" y="154.998"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="1037.0059" style="stroke:#A80036;stroke-width:1.0;" width="10" x="425.5" y="184.3086"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="809.1426" style="stroke:#A80036;stroke-width:1.0;" width="10" x="654.5" y="298.2402"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="257.1738" style="stroke:#A80036;stroke-width:1.0;" width="10" x="905.5" y="370.8613"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="113.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1133.5" y="400.1719"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="215.1738" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1295.5" y="827.5879"/><rect fill="#FFFFFF" filter="url(#f1lbbt3w3hemu4)" height="185.8633" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1557.5" y="856.8984"/><polygon fill="#A80036" points="179.5,150.998,189.5,154.998,179.5,158.998,183.5,154.998" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="38.5" x2="185.5" y1="154.998" y2="154.998"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="45.5" y="150.2559">Enter question</text><polygon fill="#A80036" points="413.5,180.3086,423.5,184.3086,413.5,188.3086,417.5,184.3086" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="201.5" x2="419.5" y1="184.3086" y2="184.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="208.5" y="179.5664">send_message_stream(question)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="435.5" x2="477.5" y1="213.6191" y2="213.6191"/><line style="stroke:#A80036;stroke-width:1.0;" x1="477.5" x2="477.5" y1="213.6191" y2="226.6191"/><line style="stroke:#A80036;stroke-width:1.0;" x1="436.5" x2="477.5" y1="226.6191" y2="226.6191"/><polygon fill="#A80036" points="446.5,222.6191,436.5,226.6191,446.5,230.6191,442.5,226.6191" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="442.5" y="208.877">Create user Message entity</text><line style="stroke:#A80036;stroke-width:1.0;" x1="435.5" x2="477.5" y1="255.9297" y2="255.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="477.5" x2="477.5" y1="255.9297" y2="268.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="436.5" x2="477.5" y1="268.9297" y2="268.9297"/><polygon fill="#A80036" points="446.5,264.9297,436.5,268.9297,446.5,272.9297,442.5,268.9297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="442.5" y="251.1875">Add to session</text><polygon fill="#A80036" points="642.5,294.2402,652.5,298.2402,642.5,302.2402,646.5,298.2402" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="435.5" x2="648.5" y1="298.2402" y2="298.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="200" x="442.5" y="293.498">query_stream(question, history)</text><rect fill="#EEEEEE" filter="url(#f1lbbt3w3hemu4)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1630" x="0" y="326.8955"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1630" y1="326.8955" y2="326.8955"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1630" y1="329.8955" y2="329.8955"/><rect fill="#EEEEEE" filter="url(#f1lbbt3w3hemu4)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="122" x="754" y="316.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="104" x="760" y="332.8086">Retrieval Phase</text><polygon fill="#A80036" points="893.5,366.8613,903.5,370.8613,893.5,374.8613,897.5,370.8613" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="664.5" x2="899.5" y1="370.8613" y2="370.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190" x="671.5" y="366.1191">search_similar(query, top_k:5)</text><polygon fill="#A80036" points="1121.5,396.1719,1131.5,400.1719,1121.5,404.1719,1125.5,400.1719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="915.5" x2="1127.5" y1="400.1719" y2="400.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="922.5" y="395.4297">query(query_texts, n_results:5)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1143.5" x2="1185.5" y1="429.4824" y2="429.4824"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1185.5" x2="1185.5" y1="429.4824" y2="442.4824"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1144.5" x2="1185.5" y1="442.4824" y2="442.4824"/><polygon fill="#A80036" points="1154.5,438.4824,1144.5,442.4824,1154.5,446.4824,1150.5,442.4824" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="1150.5" y="424.7402">Compute embeddings</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1143.5" x2="1185.5" y1="471.793" y2="471.793"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1185.5" x2="1185.5" y1="471.793" y2="484.793"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1144.5" x2="1185.5" y1="484.793" y2="484.793"/><polygon fill="#A80036" points="1154.5,480.793,1144.5,484.793,1154.5,488.793,1150.5,484.793" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="1150.5" y="467.0508">Search similar vectors</text><polygon fill="#A80036" points="926.5,510.1035,916.5,514.1035,926.5,518.1035,922.5,514.1035" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="920.5" x2="1137.5" y1="514.1035" y2="514.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="932.5" y="509.3613">Chunks with distances</text><line style="stroke:#A80036;stroke-width:1.0;" x1="915.5" x2="957.5" y1="543.4141" y2="543.4141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="957.5" x2="957.5" y1="543.4141" y2="556.4141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="916.5" x2="957.5" y1="556.4141" y2="556.4141"/><polygon fill="#A80036" points="926.5,552.4141,916.5,556.4141,926.5,560.4141,922.5,556.4141" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="922.5" y="538.6719">Convert distances to similarities</text><line style="stroke:#A80036;stroke-width:1.0;" x1="915.5" x2="957.5" y1="585.7246" y2="585.7246"/><line style="stroke:#A80036;stroke-width:1.0;" x1="957.5" x2="957.5" y1="585.7246" y2="598.7246"/><line style="stroke:#A80036;stroke-width:1.0;" x1="916.5" x2="957.5" y1="598.7246" y2="598.7246"/><polygon fill="#A80036" points="926.5,594.7246,916.5,598.7246,926.5,602.7246,922.5,598.7246" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="922.5" y="580.9824">Create partial Documents</text><polygon fill="#A80036" points="675.5,624.0352,665.5,628.0352,675.5,632.0352,671.5,628.0352" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="669.5" x2="909.5" y1="628.0352" y2="628.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="184" x="681.5" y="623.293">List of (Document, similarity)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="664.5" x2="706.5" y1="657.3457" y2="657.3457"/><line style="stroke:#A80036;stroke-width:1.0;" x1="706.5" x2="706.5" y1="657.3457" y2="670.3457"/><line style="stroke:#A80036;stroke-width:1.0;" x1="665.5" x2="706.5" y1="670.3457" y2="670.3457"/><polygon fill="#A80036" points="675.5,666.3457,665.5,670.3457,675.5,674.3457,671.5,670.3457" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="671.5" y="652.6035">Filter by threshold (greater than 0.5)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="664.5" x2="706.5" y1="699.6563" y2="699.6563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="706.5" x2="706.5" y1="699.6563" y2="712.6563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="665.5" x2="706.5" y1="712.6563" y2="712.6563"/><polygon fill="#A80036" points="675.5,708.6563,665.5,712.6563,675.5,716.6563,671.5,712.6563" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="671.5" y="694.9141">Build context from chunks</text><rect fill="#EEEEEE" filter="url(#f1lbbt3w3hemu4)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1630" x="0" y="741.3115"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1630" y1="741.3115" y2="741.3115"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1630" y1="744.3115" y2="744.3115"/><rect fill="#EEEEEE" filter="url(#f1lbbt3w3hemu4)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="137" x="746.5" y="730.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="119" x="752.5" y="747.2246">Generation Phase</text><line style="stroke:#A80036;stroke-width:1.0;" x1="664.5" x2="706.5" y1="785.2773" y2="785.2773"/><line style="stroke:#A80036;stroke-width:1.0;" x1="706.5" x2="706.5" y1="785.2773" y2="798.2773"/><line style="stroke:#A80036;stroke-width:1.0;" x1="665.5" x2="706.5" y1="798.2773" y2="798.2773"/><polygon fill="#A80036" points="675.5,794.2773,665.5,798.2773,675.5,802.2773,671.5,798.2773" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="671.5" y="780.5352">Prepare messages with context</text><polygon fill="#A80036" points="1283.5,823.5879,1293.5,827.5879,1283.5,831.5879,1287.5,827.5879" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="664.5" x2="1289.5" y1="827.5879" y2="827.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="294" x="671.5" y="822.8457">generate_response_stream(messages, context)</text><polygon fill="#A80036" points="1545.5,852.8984,1555.5,856.8984,1545.5,860.8984,1549.5,856.8984" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1305.5" x2="1551.5" y1="856.8984" y2="856.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="1312.5" y="852.1563">Create chat completion (stream:True)</text><path d="M10,871.8984 L84,871.8984 L84,878.8984 L74,888.8984 L10,888.8984 L10,871.8984 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="163.8633" style="stroke:#000000;stroke-width:2.0;" width="1610" x="10" y="871.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="25" y="885.4668">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="90" x="99" y="884.5332">[Stream chunks]</text><polygon fill="#A80036" points="1316.5,906.5195,1306.5,910.5195,1316.5,914.5195,1312.5,910.5195" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1310.5" x2="1556.5" y1="910.5195" y2="910.5195"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="1322.5" y="905.7773">Response chunk</text><polygon fill="#A80036" points="675.5,935.8301,665.5,939.8301,675.5,943.8301,671.5,939.8301" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="669.5" x2="1294.5" y1="939.8301" y2="939.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="681.5" y="935.0879">Text chunk</text><polygon fill="#A80036" points="446.5,965.1406,436.5,969.1406,446.5,973.1406,442.5,969.1406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="440.5" x2="653.5" y1="969.1406" y2="969.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="452.5" y="964.3984">Text chunk</text><polygon fill="#A80036" points="212.5,994.4512,202.5,998.4512,212.5,1002.4512,208.5,998.4512" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="206.5" x2="424.5" y1="998.4512" y2="998.4512"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="90" x="218.5" y="993.709">Display chunk</text><polygon fill="#A80036" points="49.5,1023.7617,39.5,1027.7617,49.5,1031.7617,45.5,1027.7617" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="43.5" x2="190.5" y1="1027.7617" y2="1027.7617"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="55.5" y="1023.0195">Show streaming text</text><rect fill="#EEEEEE" filter="url(#f1lbbt3w3hemu4)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1630" x="0" y="1063.417"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1630" y1="1063.417" y2="1063.417"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1630" y1="1066.417" y2="1066.417"/><rect fill="#EEEEEE" filter="url(#f1lbbt3w3hemu4)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="96" x="767" y="1052.7617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="78" x="773" y="1069.3301">Finalization</text><polygon fill="#A80036" points="446.5,1103.3828,436.5,1107.3828,446.5,1111.3828,442.5,1107.3828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="440.5" x2="658.5" y1="1107.3828" y2="1107.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="452.5" y="1102.6406">Source document IDs</text><line style="stroke:#A80036;stroke-width:1.0;" x1="435.5" x2="477.5" y1="1136.6934" y2="1136.6934"/><line style="stroke:#A80036;stroke-width:1.0;" x1="477.5" x2="477.5" y1="1136.6934" y2="1149.6934"/><line style="stroke:#A80036;stroke-width:1.0;" x1="436.5" x2="477.5" y1="1149.6934" y2="1149.6934"/><polygon fill="#A80036" points="446.5,1145.6934,436.5,1149.6934,446.5,1153.6934,442.5,1149.6934" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="442.5" y="1131.9512">Create assistant Message</text><line style="stroke:#A80036;stroke-width:1.0;" x1="435.5" x2="477.5" y1="1179.0039" y2="1179.0039"/><line style="stroke:#A80036;stroke-width:1.0;" x1="477.5" x2="477.5" y1="1179.0039" y2="1192.0039"/><line style="stroke:#A80036;stroke-width:1.0;" x1="436.5" x2="477.5" y1="1192.0039" y2="1192.0039"/><polygon fill="#A80036" points="446.5,1188.0039,436.5,1192.0039,446.5,1196.0039,442.5,1192.0039" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="442.5" y="1174.2617">Add to session</text><polygon fill="#A80036" points="212.5,1217.3145,202.5,1221.3145,212.5,1225.3145,208.5,1221.3145" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="206.5" x2="429.5" y1="1221.3145" y2="1221.3145"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="218.5" y="1216.5723">Complete message</text><polygon fill="#A80036" points="49.5,1246.625,39.5,1250.625,49.5,1254.625,45.5,1250.625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="43.5" x2="195.5" y1="1250.625" y2="1250.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="55.5" y="1245.8828">Show sources</text><!--MD5=[351d6c749ed5aa0414387a4fdda8ae2b]
@startuml

title RAG Query Flow (Retrieval-Augmented Generation)

actor User
participant "Streamlit UI" as UI
participant "Chat Service" as Chat
participant "RAG Service" as RAG
participant "ChromaDocumentRepository" as Repo
participant "ChromaDB" as Chroma
participant "OpenAI Service" as OpenAI
participant "OpenAI API" as API

User -> UI: Enter question
activate UI

UI -> Chat: send_message_stream(question)
activate Chat

Chat -> Chat: Create user Message entity
Chat -> Chat: Add to session

Chat -> RAG: query_stream(question, history)
activate RAG

== Retrieval Phase ==

RAG -> Repo: search_similar(query, top_k:5)
activate Repo

Repo -> Chroma: query(query_texts, n_results:5)
activate Chroma
Chroma -> Chroma: Compute embeddings
Chroma -> Chroma: Search similar vectors
Chroma - -> Repo: Chunks with distances
deactivate Chroma

Repo -> Repo: Convert distances to similarities
Repo -> Repo: Create partial Documents
Repo - -> RAG: List of (Document, similarity)
deactivate Repo

RAG -> RAG: Filter by threshold (greater than 0.5)
RAG -> RAG: Build context from chunks

== Generation Phase ==

RAG -> RAG: Prepare messages with context
RAG -> OpenAI: generate_response_stream(messages, context)
activate OpenAI

OpenAI -> API: Create chat completion (stream:True)
activate API

loop Stream chunks
    API - -> OpenAI: Response chunk
    OpenAI - -> RAG: Text chunk
    RAG - -> Chat: Text chunk
    Chat - -> UI: Display chunk
    UI - -> User: Show streaming text
end

deactivate API
deactivate OpenAI

== Finalization ==

RAG - -> Chat: Source document IDs
deactivate RAG

Chat -> Chat: Create assistant Message
Chat -> Chat: Add to session
Chat - -> UI: Complete message
deactivate Chat

UI - -> User: Show sources
deactivate UI

@enduml

PlantUML version 1.2021.00(Sun Jan 10 18:25:05 SGT 2021)
(MIT source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: SG
--></g></svg>